{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://apgms.example.com/schemas/redteam.run.report.schema.json",
  "title": "Red Team Runner Report",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "run_id",
    "generated_at",
    "runner",
    "totals",
    "cases",
    "failures"
  ],
  "properties": {
    "run_id": {
      "type": "string",
      "pattern": "^[A-Za-z0-9_.-]+$",
      "description": "Unique identifier for the runner execution."
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp when the report was created."
    },
    "runner": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "version"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "version": {
          "type": "string",
          "minLength": 1
        },
        "environment": {
          "type": "object",
          "additionalProperties": {
            "type": [
              "string",
              "number",
              "boolean"
            ]
          }
        }
      }
    },
    "totals": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "cases",
        "passed",
        "failed",
        "outcomes"
      ],
      "properties": {
        "cases": {
          "type": "integer",
          "minimum": 0
        },
        "passed": {
          "type": "integer",
          "minimum": 0
        },
        "failed": {
          "type": "integer",
          "minimum": 0
        },
        "checks_evaluated": {
          "type": "integer",
          "minimum": 0
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0
        },
        "outcomes": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "refuse",
            "error",
            "allowed"
          ],
          "properties": {
            "refuse": {
              "type": "integer",
              "minimum": 0
            },
            "error": {
              "type": "integer",
              "minimum": 0
            },
            "allowed": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      }
    },
    "cases": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/caseResult"
      }
    },
    "failures": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/failure"
      }
    },
    "attachments": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/attachment"
      }
    }
  },
  "$defs": {
    "attachment": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "content_type",
        "href"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "content_type": {
          "type": "string",
          "minLength": 1
        },
        "href": {
          "type": "string",
          "format": "uri"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "caseResult": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "kind",
        "expected_outcome",
        "actual_outcome",
        "success",
        "checks"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_.-]+$"
        },
        "kind": {
          "type": "string",
          "enum": [
            "llm",
            "api"
          ]
        },
        "expected_outcome": {
          "type": "string",
          "enum": [
            "refuse",
            "error",
            "allowed"
          ]
        },
        "actual_outcome": {
          "type": "string",
          "enum": [
            "refuse",
            "error",
            "allowed"
          ]
        },
        "success": {
          "type": "boolean"
        },
        "latency_ms": {
          "type": "integer",
          "minimum": 0
        },
        "error": {
          "type": "string"
        },
        "refusal_reason": {
          "type": "string"
        },
        "checks": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/checkResult"
          }
        }
      }
    },
    "checkResult": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "passed"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_.-]+$"
        },
        "type": {
          "type": "string",
          "enum": [
            "must_include",
            "must_not_include",
            "status"
          ]
        },
        "passed": {
          "type": "boolean"
        },
        "value": {
          "type": "string"
        },
        "operator": {
          "type": "string",
          "enum": [
            ">=",
            "=="
          ]
        },
        "status_code": {
          "type": "integer",
          "minimum": 100,
          "maximum": 599
        },
        "observed": {
          "type": [
            "string",
            "integer",
            "null"
          ]
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "const": "status"
              }
            }
          },
          "then": {
            "required": [
              "operator",
              "status_code"
            ],
            "properties": {
              "value": false
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "enum": [
                  "must_include",
                  "must_not_include"
                ]
              }
            }
          },
          "then": {
            "required": [
              "value"
            ],
            "properties": {
              "operator": false,
              "status_code": false
            }
          }
        }
      ]
    },
    "failure": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "case_id",
        "reason"
      ],
      "properties": {
        "case_id": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_.-]+$"
        },
        "reason": {
          "type": "string",
          "minLength": 1
        },
        "actual_outcome": {
          "type": "string",
          "enum": [
            "refuse",
            "error",
            "allowed"
          ]
        },
        "failed_checks": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_.-]+$"
          }
        }
      }
    }
  }
}
